<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matching Service</title>
</head>
<body>
  <h1>Matching Service</h1>

  <!-- Input for User ID -->
  <label for="userId">Enter User ID:</label>
  <input type="text" id="userId" placeholder="Enter your User ID" />

  <!-- Input for Category -->
  <label for="category">Select Category:</label>
  <select id="category">
    <option value="Algorithms">Algorithms</option>
    <option value="Bit Manipulation">Bit Manipulation</option>
    <option value="Data Structures">Data Structures</option>
    <option value="Databases">Databases</option>
    <option value="Recursion">Recursion</option>
  </select>

  <label for="difficulty">Select Difficulty:</label>
  <select id="difficulty">
    <option value="EASY">Easy</option>
    <option value="MEDIUM">Medium</option>
    <option value="HARD">Hard</option>
  </select>

  <button id="sendRequestBtn">Send Match Request</button>

  <div id="result">Welcome! Please choose a category and difficulty.</div>
  <div id="timer">Time in queue: 0s</div>

  <script>
    let timerInterval; // To keep track of the timer interval

    const pollForMatch = async (userId) => {
      try {
        const response = await fetch(`/api/match/check-match-status/${userId}`);
        const result = await response.json();

        if (result.matched) {
          clearInterval(timerInterval);  // Stop the timer when matched
          document.getElementById('result').innerText = `Matched with User ${result.partnerId}! You will be attempting a ${result.difficultyAssigned} question about ${result.categoryAssigned}`;
        } else if (result.removed) {
          clearInterval(timerInterval);  // Stop the timer if removed
          document.getElementById('result').innerText = `You have been removed from the queue :(`;
        } else {
          setTimeout(() => pollForMatch(userId), 500);  // Poll every 0.5 seconds
        }
      } catch (error) {
        console.error('Error checking match status:', error);
      }
    };

    const startTimer = () => {
      let secondsInQueue = 0;  // Initialize time at 0 seconds
      const timerElement = document.getElementById('timer');
      timerElement.innerText = `Time in queue: ${secondsInQueue}s`;

      // Clear any existing interval before starting a new one
      if (timerInterval) {
        clearInterval(timerInterval);
      }

      // Increment the timer every second
      timerInterval = setInterval(() => {
        secondsInQueue += 1;
        timerElement.innerText = `Time in queue: ${secondsInQueue}s`;

        // Stop after 45 seconds if needed
        if (secondsInQueue >= 45) {
          clearInterval(timerInterval);
        }
      }, 1000);  // 1 second interval
    };

    document.getElementById('sendRequestBtn').addEventListener('click', async () => {
      const userId = document.getElementById('userId').value;
      const category = document.getElementById('category').value;
      const difficulty = document.getElementById('difficulty').value;

      if (!userId) {
        document.getElementById('result').innerText = 'Please enter a valid User ID.';
        return;
      }

      document.getElementById('result').innerText = 'Sending match request...';

      try {
        const response = await fetch('/api/match/match-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId,
            category,
            difficulty,
          }),
        });

        const result = await response.json();
        document.getElementById('result').innerText = 'Waiting for match...';

        // Start polling for match updates and start the timer
        pollForMatch(userId);
        startTimer();  // Start the timer once the match request is sent
      } catch (error) {
        console.error('Error sending match request:', error);
        document.getElementById('result').innerText = 'Failed to send request.';
      }
    });
  </script>
</body>
</html>
